{
  "incident_id": "INC_20251022_vercel_build_types",
  "timestamp": 1729624800000,
  "symptom": "Vercel production build failed with TypeScript error: Could not find a declaration file for module 'turndown'",
  "symptom_type": "build",
  "root_cause": {
    "description": "Vercel build failure due to missing TypeScript type definitions for turndown library. The turndown package doesn't ship with built-in .d.ts files, requiring @types/turndown from DefinitelyTyped for production builds. Local dev mode is more lenient, but Vercel enforces strict TypeScript compilation (noEmit: false). This discrepancy between local and production environments caused the build to succeed locally but fail in Vercel's CI/CD pipeline.",
    "file": "package.json",
    "category": "build",
    "confidence": 0.95,
    "code_snippet": "// Error from Vercel build logs:\nType error: Could not find a declaration file for module 'turndown'.\n'/vercel/path0/node_modules/turndown/lib/turndown.cjs.js' implicitly has an 'any' type.\nTry `npm i --save-dev @types/turndown` if it exists\n\n// Missing from package.json:\n\"devDependencies\": {\n  // @types/turndown was missing\n}",
    "additional_files": [
      "package-lock.json",
      "lib/formatters/html-to-markdown.ts"
    ]
  },
  "fix": {
    "approach": "Installed @types/turndown as devDependency to provide TypeScript type definitions during compilation. This package is maintained by DefinitelyTyped community and provides comprehensive type declarations for the turndown library, enabling TypeScript compiler to validate usage and provide autocomplete.",
    "changes": [
      {
        "file": "package.json",
        "lines_changed": 1,
        "change_type": "add",
        "summary": "Added @types/turndown to devDependencies"
      },
      {
        "file": "package-lock.json",
        "lines_changed": 8,
        "change_type": "modify",
        "summary": "Updated dependency tree with @types/turndown package and its dependencies"
      }
    ],
    "time_to_fix": 5,
    "commands_run": [
      "npm install --save-dev @types/turndown",
      "git add package.json package-lock.json",
      "git commit -m 'fix: add @types/turndown for TypeScript compilation'",
      "git push origin main"
    ]
  },
  "verification": {
    "status": "verified",
    "regression_tests_passed": true,
    "user_journey_tested": false,
    "success_criteria_met": true,
    "verification_method": "Vercel automatic rebuild triggered by GitHub push. Build logs will show successful TypeScript compilation."
  },
  "tags": [
    "vercel",
    "typescript",
    "build",
    "types",
    "turndown",
    "deployment",
    "ci-cd",
    "dev-prod-parity"
  ],
  "files_changed": [
    "package.json",
    "package-lock.json"
  ],
  "agent_used": "coder",
  "quality_gates": {
    "guardian_validated": false,
    "tested_e2e": false,
    "tested_from_ui": false,
    "security_reviewed": false,
    "architect_reviewed": false
  },
  "completeness": {
    "symptom": true,
    "root_cause": true,
    "fix": true,
    "verification": true,
    "quality_score": 0.88
  },
  "lessons_learned": [
    "Vercel's production build is stricter than Next.js dev mode with TypeScript checking",
    "Always install @types/* packages for third-party libraries without built-in types",
    "Local dev success doesn't guarantee production build success",
    "Check DefinitelyTyped (@types/*) when TypeScript can't find module declarations",
    "Test production builds locally before pushing: npm run build"
  ],
  "prevention": {
    "pattern": "When installing packages without built-in TypeScript support, immediately check if @types/* equivalent exists and install it alongside the main package",
    "checklist": [
      "After npm install <package>, check if types are built-in (has .d.ts files)",
      "If no built-in types, search for @types/<package> on npm",
      "Install @types/* as devDependency: npm install --save-dev @types/<package>",
      "Run npm run build locally to verify TypeScript compilation before pushing",
      "Monitor Vercel build logs for type errors during first deployment"
    ],
    "detection": "Run `npx tsc --noEmit` locally to catch type errors before Vercel",
    "related_patterns": [
      "Missing type definitions pattern (turndown, cheerio, etc.)",
      "Dev-prod environment parity issues",
      "TypeScript strict mode discrepancies"
    ]
  },
  "references": {
    "vercel_logs": "Build failed at TypeScript compilation step",
    "similar_packages": [
      "@types/cheerio",
      "@types/jsdom",
      "@types/node"
    ],
    "documentation": "https://www.typescriptlang.org/docs/handbook/declaration-files/consumption.html"
  }
}
